# 前言：

### MySql如何优化

- 定位慢查询
- 表/数据库的设计合理化【符合三范式(3NF)】
- 添加适当的索引【index】（普通索引、逐渐索引、唯一索引、全文索引）
- Sql语句优化
- 分表技术【水平拆分、垂直拆分】
- 读写【写：update/delete/add】分离：MyChar
- 存储过程【模块化编程，可提高速度，但是有一个弊端：sql是死的】
- 对mysql配置优化【my.ini，最大并发数，调整缓存大小】
- 定时进行碎片整理【MyISAM】





# 一、数据库三大范式

1. 第一范式：原子性约束，要求属性【列】具有原子性，不可再分解。（关系型数据库都满足1NF）
2. 第二范式：唯一性约束，要求表中记录是唯一的
3. 第三范式：字段冗余性的约束，要求字段没有冗余。

> 注意：没有冗余的数据库未必是最好的数据库，也并不一定就要将字段拆成具有原子性，一切都要由业务决定。



# 二、数据库分表分库

### 2.1 分库分表如何选择

- **分库：**解决大数据量问题。【一般用于电商项目，每个服务一个单独数据库。------垂直分割】
- **分表：**解决数据过多的问题。】根据业务需求，存放日志（每年存放）此时根据年份分表-----水平分割】

> 分表时，通常用年份分割，qq号位数分割，手机号会用前三位分割，但是这种分割都不均匀。最均匀的方式是取模分割。



### 2.2 分表的缺点

1. 分页查询
2. 查询受限制，查询需要三张表。【小项目可用视图解决，一般采用主表(存所有)，从表(按业务分表)的方式】



# 三、Sql优化

### 3.1 定位慢查询

&emsp;&emsp;**慢查询：**mysql默认慢查询是10秒。



#### 3.1.1 Mysql显示状态相关常用语句

| 语句                                                         | 描述                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `show status like 'uptime;'`                                 | mysql数据库启动了多长时间                                    |
| `show status like 'com_select';`、`show status like 'com_select';` | 显示数据库的**查询，更新，添加，删除**的次数                 |
| `show [session|global] status like ...`                      | 默认是`session` 会话，指取出当前窗口的执行，所有(从mysql 启动到现在，则应该 `global`) |
| `show status like  'connections';`                           | 显示mysql数据库的连接数                                      |
| `show status like 'slow_queries';`                           | 查询慢查询次数                                               |



#### 3.1.2 查询与设置慢查询时间

| 语句                                     | 描述                               |
| ---------------------------------------- | ---------------------------------- |
| `show variables like 'long_query_time';` | 查询慢查询时间                     |
| `set long_query_time=1;`                 | 修改慢查询时间为`1`秒 ，重启后恢复 |



#### 3.1.3 在日志中定位慢查询

```shell
# my.ini 文件中记录的位置
# Path to the database root
datadir=" C:/ProgramData/MySQL/MySQL Server 5.5/Data/"
```

1. 进入bin目录
2. `mysqld.exe --safe-mode  --slow-query-log`【安全模式启动，数据库将操作写入日志，以备恢复】
3. `mysqld.exe –log-slow-queries=d:/abc.log`【低版本mysql5.0可以在my.ini指定】



### 3.2 索引

&emsp;&emsp;索引能够提高查询效率，那么为什么，其内部是如何实现的。【折半查找】



#### 3.2.1 索引分类

- **主键索引**：`primary key`
- **唯一索引**：加上唯一标识，用的不多。基本都被主键代替
- **组合索引**：多个列一起创建索引，只有第一个参数出现在`where`后时才会生效。【待验证】
- **全文索引**：`FULLTEXT (列名,列名)`在建表时创建全文索引
- **普通索引**：创建语句`create index 索引名 on 表 (列1[,列名2]);`



#### 3.2.2 数据库文件

- **.MYI**：索引文件
- **.MYD**：数据结构文件
- **.frm**：表结构文件



> 数据库对查询是会做优化的，所以第一次最慢！



#### 3.2.3 索引实现原理

&emsp;&emsp;索引底层采用`b-tree`。创建索引后，先生成索引文件，先取一个中间数做为第一个节点，左边是小的数中的中间数，右边是大的数中的中间数。

> **索引的缺点：**增加、删除时索引文件也需要更新。





#### 3.2.4 执行计划

&emsp;&emsp;`expain`将此关键字加在查询语句前。观察`type`列，`ref`：索引查询，`all`:表示全表扫描，`const`：使用索引文件





#### 3.2.5 全文索引

**错误的用法：**全文索引不会生效

&emsp;&emsp;`select * from articles where body like '%mysql%';`

**正确的用法：**

&emsp;&emsp;`select * from articles where match(列名,列名) against ( '模糊参数')`

**输出与查找内容的精准度：**

&emsp;&emsp;`select match(列名,列名) against ('模糊参数') from articles;`



**注：**全文索引有停止词的概念，例如（a，b，mysql，the）就不会创建索引。

> 企业中并不会使用全文索引的，只有`myisam`引擎才支持全文索引。一般使用第三方搜索引擎框架。





#### 3.2.6 什么字段适合加索引

&emsp;&emsp;查询次数较多，值多且不同又不经常修改。不需要被`where`，就几个值的就不需要索引。



### 3.3 SQL优化注意事项

1. 组合查询时，只有第一个条件是创建时的第一个索引的时候才能生效。
2. 模糊查询时`like '%_%'`会全表扫描，要想使用索引不要在开头加`%`。【`like '_%'`】
3. 使用`or`,条件都必须加上索引 ，只要有一个条件不加索引，就会全表扫描。
4. 判断是否为`null`时，使用`is null`，不要使用`= null`会全表扫描。
5. `group by`分组默认会排序不会使用索引，全表扫描。禁用排序`order by null`可提升效率。大量的分组建议用视图。
6. 不要使用`>=`、`<=`这回使得数据库需要做两次判断，降低运行效率。
7. `in`、`not in`会全表扫描。
8. 查询量非常大的时候，缓存、分表、分页





# 四、mysql数据引擎

|     特点     | Myisam | InnoDB | BDB  | Memory | Archive |
| :----------: | :----: | :----: | :--: | :----: | :-----: |
| 批量插入速度 |   高   |   低   |  高  |   高   | 非常高  |
|   事务安全   |        |  支持  | 支持 |        |         |
|   全文索引   |  支持  |        |      |        |         |
|    锁机制    |  表锁  |  行锁  | 页锁 |  表锁  |  行锁   |
|   存储限制   |  没有  |  64TB  | 没有 |   有   |  没有   |
|   B树索引    |  支持  |  支持  | 支持 |  支持  |         |
|   哈希索引   |        |  支持  |      |  支持  |         |
|   集群索引   |        |  支持  |      |        |         |
|   数据缓存   |        |  支持  |      |  支持  |         |
|   索引缓存   |  支持  |  支持  |      |  支持  |         |
|  数据可压缩  |  支持  |        |      |        |  支持   |
|   空间使用   |   低   |   高   |  低  |  N/A   | 非常低  |
|   内存使用   |   低   |   高   |  低  |  中等  |   低    |
|   支持外建   |        |  支持  |      |        |         |



### 4.1 myisam、INNODB说明

1. **myisam：**对事务要求不高，以查询和添加为主。比如：bbs中发帖表，回复表
2. **INNODB：**对事务要求高，数据相对重要。比如：订单表，账号表



### 4.2 myisam、INNODB区别

1. 事务安全：MyISAM不支持事务，INNODB支持事务
2. 查询速度和添加速度（MyISAM批量插入速度快）
3. 全文索引（MyISAM支持全文索引，但是不支持中文，也没人用）
4. 锁机制（MyISAM是表锁，innodb是行锁）
5. 外建（只有Innodb支持外建，不过基本上外建也没人用了）



### 4.3 Memory存储引擎

&emsp;&emsp;数据变化频繁是，不需要入库，同时又频繁的查询修改，这是考虑使用，但是mysql重启数据丢失。



### 4.4 MyIsam注意事项

&emsp;&emsp;例如我们存储了一堆数据，删除时`MYD`文件大小并不会变化。这是我们需要进行碎片整理。

通过语句：`optimize table 表名;`



> **MyIsam批量查询：**`insert into 表名 select 列名,列名 from 表名;`

&emsp;&emsp;